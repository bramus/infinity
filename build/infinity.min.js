//     (c) 2012 Airbnb, Inc.
//     
//     infinity.js may be freely distributed under the terms of the BSD
//     license. For all licensing information, details, and documentation:
//     http://airbnb.github.com/infinity
!function(e,t,n){"use strict";function l(e,t){t=t||{},this.$el=e,this.$shadow=M(),this.lazy=!!t.lazy,this.lazyFn=t.lazy||null,this.landscape=t.landscape||!1,this.itemSelector=t.itemSelector||"> div",this.filter=t.filter||!1,this.itemSizer=t.itemSizer||null,this.items=[],this.filteredItems=[];var n=c(this);p(this),this.landscape?this.begin=this.$el.offset().left:this.begin=this.$el.offset().top,this.width=t.width||0,this.height=t.height||0,this.landscape&&this.height?this.$el.height(this.height):this.width&&this.$el.width(this.width),this.pages=[],this.startIndex=0,this.$scrollParent=t.scrollParent||r,h(this,n),C.attach(this)}function c(e){var t=e.$el.find(e.itemSelector);return e.$el.empty(),t}function h(e,t){t.each(function(){e.append(n(this))})}function p(e){e._$buffer=M().attr("data-infinity-buffer","").prependTo(e.$el)}function d(e){var t,n=e.pages,r=e._$buffer;n.length>0?(t=n[e.startIndex],e.landscape?r.width(t.begin):r.height(t.begin)):e.landscape?r.width(0):r.height(0)}function m(e,t,n){var r=e.length,i,s;for(i=n||0;i<r;i++)s=e[i],s.begin+=t,s.end+=t,g(s.items,t)}function g(e,t,n){var r=e.length,i,s;for(i=n||0;i<r;i++)s=e[i],s.begin+=t,s.end+=t}function y(e,t,n){var r,i=t.$el;e.itemSizer&&(r=e.itemSizer(i)),r?(t.width=r.width,t.height=r.height):(i.detach(),n?e.$el.prepend(i):e.$el.append(i),e.landscape?(t.width=i.outerWidth(!0),t.height=i.height()):(t.height=i.outerHeight(!0),t.width=i.width()),i.detach()),e.landscape?(t.begin=n?0:e.width,t.end=t.begin+t.width):(t.begin=n?0:e.height,t.end=t.begin+t.height),i.attr("data-infinity-begin",t.begin).attr("data-infinity-end",t.end).attr("data-infinity-width",t.width).attr("data-infinity-height",t.height)}function b(e){var n,r,i,s=e.pages,o=!1,u=!0;n=e.startIndex,r=t.min(n+f,s.length);for(n;n<r;n++)i=s[n],e.lazy&&i.lazyload(e.lazyFn),o&&i.onscreen&&(u=!1),u?i.onscreen||(o=!0,i.appendTo(e.$el)):(i.stash(e.$shadow),i.appendTo(e.$el))}function w(e,n){var r,i,s,o,u,a=e.startIndex,l=e.$scrollParent;if(e.landscape)var c=l.scrollLeft()-e.begin,h=l.width(),p=c+h,v=T(e,c,p);else var m=l.scrollTop()-e.begin,g=l.height(),y=m+g,v=T(e,m,y);if(v<0||v===a&&!n)return a;s=e.pages,a=e.startIndex,o=t.min(a+f,s.length),u=t.min(v+f,s.length);for(r=a,i=o;r<i;r++)(r<v||r>=u)&&s[r].stash(e.$shadow);return e.startIndex=v,b(e),d(e),v}function E(e,t,r){var i;return t instanceof O?t:(typeof t=="string"&&(t=n(t)),i=new O(t),y(e,i,r),i)}function S(e,t){x(e)}function x(e){var t,n,r,i,s,o,u,a,f=[],l=e.filteredItems;t=new k(e),f.push(t);for(i=0,s=l.length;i<s;i++)u=l[i],a=u.clone(),t.hasVacancy()?t.append(a):(t=new k(e),f.push(t),t.append(a));e.setPages(f),b(e)}function T(e,n,r){var i=N(e,n,r);return i=t.max(i-a,0),i=t.min(i,e.pages.length),i}function N(e,n,r){var i,s,o,u,f,l,c,h=e.pages,p=n+(r-n)/2;u=t.min(e.startIndex+a,h.length-1);if(h.length<=0)return-1;o=h[u],e.landscape?f=o.begin+o.width/2:f=o.begin+o.height/2,c=p-f;if(c<0){for(i=u-1;i>=0;i--){o=h[i],e.landscape?f=o.begin+o.width/2:f=o.begin+o.height/2,l=p-f;if(l>0)return l<-c?i:i+1;c=l}return 0}if(c>0){for(i=u+1,s=h.length;i<s;i++){o=h[i],e.landscape?f=o.begin+o.width/2:f=o.begin+o.height/2,l=p-f;if(l<0)return-l<c?i:i-1;c=l}return h.length-1}return u}function k(e){this.parent=e,this.items=[],this.$el=M(),this.id=L.generatePageId(this),this.$el.attr(u,this.id),this.begin=0,this.end=0,this.width=0,this.height=0,this.lazyloaded=!1,this.onscreen=!1}function A(e,t){var n,r,i,s=t.items;for(n=0,r=s.length;n<r;n++)if(s[n]===e){i=n;break}return i==null?!1:(s.splice(i,1),t.parent.landscape?(t.end-=e.width,t.width=t.end-t.begin):(t.end-=e.height,t.height=t.end-t.begin),t.hasVacancy()&&S(t.parent,t),!0)}function O(e){this.$el=e,this.parent=null,this.begin=0,this.end=0,this.width=0,this.height=0}function M(){return n("<div>").css({margin:0,padding:0,border:"none"})}function _(e){var t;e?(t=e.ListView,n.fn.listView=function(e){return new t(this,e)}):delete n.fn.listView}var r=n(e),i=e.infinity,s=e.infinity={},o=s.config={},u="data-infinity-pageid",a=1,f=a*2+1;o.PAGE_TO_SCREEN_RATIO=3,o.SCROLL_THROTTLE=350,o.SCROLL_HORIZONTAL_HIJACK=!0,o.SCROLL_HORIZONTAL_FIXATEPOSITION=!1;var v=function(e,t){return t?e.$el.is(t):!0};l.prototype.filterItems=function(e){var t=this,r=n.isWindow(t.$scrollParent.get(0))?n("body"):t.$scrollParent;t.filter=e,t.landscape?(t.width=0,t._$buffer.width(0)):(t.height=0,t._$buffer.height(0));var i=[];n.each(t.items,function(n,r){v(r,e)&&(t.landscape?(r.begin=t.width,r.end=r.begin+r.width):(r.begin=t.height,r.end=r.begin+r.height),t.landscape?t.width+=r.width:t.height+=r.height,i.push(r))}),t.filteredItems=i,t.landscape?(t.$el.width(t.width),r.animate({scrollLeft:0})):(t.$el.height(t.height),r.animate({scrollTop:0})),x(t),t.$el.trigger("infinity.filterComplete",{filteredItems:t.filteredItems})},l.prototype.sortFilteredItems=function(){console.log("sortFilteredItems")},l.prototype.reset=function(){this.setItems()},l.prototype.setItems=function(e){this.items=e?e:[],this.filterItems(this.filter)},l.prototype.append=function(e){if(!e||!e.length)return null;var t=E(this,e),n=this.pages,r=n[n.length-1];this.items.push(t);if(v(t,this.filter)){this.filteredItems.push(t),this.landscape?(this.width+=t.width,this.$el.width(this.width)):(this.height+=t.height,this.$el.height(this.height));if(!r||!r.hasVacancy())r=new k(this),n.push(r);r.append(t),b(this)}return t},l.prototype.prepend=function(e){if(!e||!e.length)return null;var t,r=E(this,e,!0),i=this.pages,s=n.isWindow(this.$scrollParent.get(0))?document.body:this.$scrollParent.get(0),u;this.items.splice(0,0,r);if(v(r,this.filter)){this.filteredItems.splice(0,0,r),this.landscape?(u=s.scrollWidth,this.width+=r.width,this.$el.width(this.width)):(u=s.scrollHeight,this.height+=r.height,this.$el.height(this.height)),t=i[0];if(!t||!t.hasVacancy())t=new k(this),this.startIndex++,i.splice(0,0,t);m(i,this.landscape?r.width:r.height,1),t.prepend(r),w(this,!0),o.SCROLL_HORIZONTAL_FIXATEPOSITION&&(this.landscape?u!=s.scrollWidth&&n(s).scrollLeft(n(s).scrollLeft()+s.scrollWidth-u):u!=s.scrollHeight&&n(s).scrollTop(n(s).scrollTop()+s.scrollHeight-u))}return r},l.prototype.remove=function(){this.$el.remove(),this.cleanup()},l.prototype.setPages=function(e){if(this.pages.length>0)for(var t=this.pages.length-1;t>=0;t--)this.pages[t].remove();this.pages=e},l.prototype.find=function(e){var t,r,i;return typeof e=="string"?(r=this.$el.find(e),i=this.$shadow.find(e),this.find(r).concat(this.find(i))):e instanceof O?[e]:(t=[],e.each(function(){var e,r,i,s,o,a,f=n(this).parentsUntil("["+u+"]").andSelf().first(),l=f.parent();e=l.attr(u),r=L.lookup(e);if(r){i=r.items;for(s=0,o=i.length;s<o;s++){a=i[s];if(a.$el.is(f)){t.push(a);break}}}}),t)},l.prototype.cleanup=function(){var e=this.pages,t;C.detach(this);while(t=e.pop())t.cleanup()};var C=function(){function s(){this.scrollScheduled||(setTimeout(u.bind(this),o.SCROLL_THROTTLE),this.scrollScheduled=!0)}function u(){var e,t,r=n(this),i=r.data("infinity-boundviews");for(e=0,t=i.length;e<t;e++)w(i[e]);if(i[0].landscape)var s=r.scrollLeft(),o=s+r.width(),u=250,a=(n.isWindow(r.get(0))?document.body.scrollWidth:this.scrollWidth)-250;else var s=r.scrollTop(),o=s+r.height(),u=250,a=(n.isWindow(r.get(0))?document.body.scrollHeight:this.scrollHeight)-250;s<=u&&r.trigger("infinity.beginReached"),a<=o&&r.trigger("infinity.endReached"),this.scrollScheduled=!1}function a(){t&&clearTimeout(t),t=setTimeout(f,200)}function f(){var e,t;for(e=0;t=i[e];e++)x(t)}var e=!1,t=null,i=[];return{attach:function(t){if(!t.$scrollParent.data("infinity-eventbound")){t.$scrollParent.on("scroll.infinity",s);if(t.landscape&&o.SCROLL_HORIZONTAL_HIJACK){var u=n.isWindow(t.$scrollParent.get(0))?n("body"):t.$scrollParent;u.on("mousewheel DOMMouseScroll",function(e){var t=e.originalEvent.detail||e.originalEvent.wheelDelta;this.scrollLeft-=t,e.preventDefault()})}t.$scrollParent.data("infinity-eventbound",!0),t.$scrollParent.data("infinity-boundviews",[])}e||(r.on("resize.infinity",a),e=!0),i.push(t),t.$scrollParent.data("infinity-boundviews").push(t)},detach:function(t){var n,s;t.$scrollParent.data("infinity-eventbound")&&(t.$scrollParent.off("scroll.infinity"),t.$scrollParent.data("infinity-eventbound",!1));for(n=0,s=i.length;n<s;n++)if(i[n]===t)return i.splice(n,1),i.length===0&&(r.off("resize.infinity"),e=!1),!0;return!1}}}();k.prototype.append=function(e){var t=this.items;t.length===0&&(this.begin=e.begin),this.end=e.end,this.parent.landscape?(this.height=this.height>e.height?this.height:e.height,this.width=this.end-this.begin):(this.width=this.width>e.width?this.width:e.width,this.height=this.end-this.begin),t.push(e),e.parent=this,this.$el.append(e.$el),this.lazyloaded=!1},k.prototype.prepend=function(e){var t=this.items;this.parent.landscape?(this.end+=e.width,this.height=this.height>e.height?this.height:e.height,this.width=this.end-this.begin):(this.end+=e.height,this.width=this.width>e.width?this.width:e.width,this.height=this.end-this.begin),t.splice(0,0,e),e.parent=this,this.$el.prepend(e.$el),this.lazyloaded=!1},k.prototype.hasVacancy=function(){var e=this.parent.$scrollParent;return this.parent.landscape?this.width<e.width()*o.PAGE_TO_SCREEN_RATIO:this.height<e.height()*o.PAGE_TO_SCREEN_RATIO},k.prototype.appendTo=function(e){this.onscreen||(this.$el.appendTo(e),this.onscreen=!0)},k.prototype.prependTo=function(e){this.onscreen||(this.$el.prependTo(e),this.onscreen=!0)},k.prototype.stash=function(e){this.onscreen&&(this.$el.appendTo(e),this.onscreen=!1)},k.prototype.remove=function(){this.onscreen&&(this.$el.detach(),this.onscreen=!1),this.cleanup()},k.prototype.cleanup=function(){var e=this.items,t;this.parent=null,L.remove(this);while(t=e.pop())t.cleanup()},k.prototype.lazyload=function(e){var t=this.$el,n,r;if(!this.lazyloaded){for(n=0,r=t.length;n<r;n++)e.call(t[n],t[n]);this.lazyloaded=!0}};var L=function(){var e=[];return{generatePageId:function(t){return e.push(t)-1},lookup:function(t){return e[t]||null},remove:function(t){var n=t.id;return e[n]?(e[n]=null,!0):!1}}}();O.prototype.clone=function(){var e=new O(this.$el);return e.begin=this.begin,e.end=this.end,e.width=this.width,e.height=this.height,e},O.prototype.remove=function(){this.$el.remove(),A(this,this.parent),this.cleanup()},O.prototype.cleanup=function(){this.parent=null},s.ListView=l,s.Page=k,s.ListItem=O,_(s),s.noConflict=function(){return e.infinity=i,_(i),s}}(window,Math,jQuery);